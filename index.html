<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DC Cooling Pro • PUE • Free Cooling • Part-Load • Scenarios</title>

    <!-- React (CDN) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel: JSX'i tarayıcıda derlemek için -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root { color-scheme: light; }
      body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#fafafa; }
      .wrap { padding: 16px; max-width: 1180px; margin: 0 auto; line-height: 1.35; }
      .header { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
      h1 { margin:0; font-size:18px; font-weight:900; letter-spacing:.2px; }
      .sub { font-size:12px; opacity:.78; margin-top:4px; }
      .badge { font-size:12px; padding:6px 10px; border:1px solid rgba(0,0,0,.14); border-radius:999px; background:#fff; }
      .tabs { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 12px; }
      .tabBtn { padding:8px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.14); background:#fff; cursor:pointer; font-weight:700; font-size:13px; }
      .tabBtn.active { background: rgba(0,0,0,.06); }
      .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; align-items:start; }
      .card { grid-column: span 6; border:1px solid rgba(0,0,0,.14); border-radius:14px; padding:12px; background: #fff; }
      .card4 { grid-column: span 4; border:1px solid rgba(0,0,0,.14); border-radius:14px; padding:12px; background: #fff; }
      .card12 { grid-column: span 12; border:1px solid rgba(0,0,0,.14); border-radius:14px; padding:12px; background: #fff; }
      .title { font-weight:900; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
      .row { display:grid; grid-template-columns: 1fr 140px; gap:10px; margin-bottom:10px; }
      .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px; }
      .label { font-size:12px; opacity:.75; margin-bottom:4px; font-weight:800; }
      input, select, textarea { width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(0,0,0,.18); font-size:14px; background:#fff; }
      textarea { height:140px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      .small { font-size:12px; opacity:.78; }
      .kpiGrid { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
      .kpiGrid2 { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
      .kpi { border:1px solid rgba(0,0,0,.12); border-radius:12px; padding:10px; background:#fcfcfc; }
      .kpiLbl { font-size:12px; opacity:.75; font-weight:900; }
      .kpiVal { font-size:18px; font-weight:1000; margin-top:2px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      .btn { padding:8px 10px; border-radius:10px; border:1px solid rgba(0,0,0,.14); background:#fff; cursor:pointer; font-weight:800; font-size:13px; }
      .btn.primary { background: rgba(0,0,0,.06); }
      .pill { font-size:12px; padding:4px 8px; border:1px solid rgba(0,0,0,.12); border-radius:999px; background:#fff; }
      .warn { border:1px solid rgba(180,0,0,.25); background: rgba(180,0,0,.06); padding:10px; border-radius:12px; }
      .ok { border:1px solid rgba(0,120,0,.22); background: rgba(0,120,0,.06); padding:10px; border-radius:12px; }
      .tooltip { display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; border-radius:999px; border:1px solid rgba(0,0,0,.18); font-size:12px; opacity:.85; }
      .right { text-align:right; }

      @media (max-width: 980px) {
        .card, .card4 { grid-column: span 12; }
        .kpiGrid { grid-template-columns: repeat(2, 1fr); }
        .row { grid-template-columns: 1fr; }
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState } = React;

      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const round = (v, d = 2) => {
        const p = Math.pow(10, d);
        return Math.round(v * p) / p;
      };

      function parseCSVTemps(text) {
        const tokens = text
          .replace(/\\r/g, "\\n")
          .split(/[\\n,; \\t]+/)
          .map((s) => s.trim())
          .filter(Boolean);

        const temps = [];
        for (let i = 0; i < tokens.length; i++) {
          const t = Number(tokens[i]);
          if (Number.isFinite(t)) temps.push(t);
        }
        return temps;
      }

      // Temsili aylık ağırlıklar (gerçek meteoroloji değildir; rapor görünümü içindir)
      const MONTH_WEIGHTS = [
        { m: "Oca", w: 0.095 }, { m: "Şub", w: 0.085 }, { m: "Mar", w: 0.085 }, { m: "Nis", w: 0.080 },
        { m: "May", w: 0.080 }, { m: "Haz", w: 0.080 }, { m: "Tem", w: 0.090 }, { m: "Ağu", w: 0.090 },
        { m: "Eyl", w: 0.080 }, { m: "Eki", w: 0.080 }, { m: "Kas", w: 0.075 }, { m: "Ara", w: 0.080 },
      ];

      const CITY_PROFILES = [
        {
          key: "istanbul",
          name: "İstanbul (Temsili)",
          bins: [
            { t: -2, h: 80 }, { t: 2, h: 400 }, { t: 6, h: 900 }, { t: 10, h: 1200 },
            { t: 14, h: 1400 }, { t: 18, h: 1300 }, { t: 22, h: 1000 }, { t: 26, h: 700 },
            { t: 30, h: 300 }, { t: 34, h: 120 }, { t: 38, h: 40 },
          ],
        },
        {
          key: "ankara",
          name: "Ankara (Temsili)",
          bins: [
            { t: -8, h: 250 }, { t: -2, h: 500 }, { t: 2, h: 850 }, { t: 6, h: 1050 },
            { t: 10, h: 1200 }, { t: 14, h: 1150 }, { t: 18, h: 1050 }, { t: 22, h: 850 },
            { t: 26, h: 600 }, { t: 30, h: 300 }, { t: 34, h: 120 }, { t: 38, h: 40 },
          ],
        },
        {
          key: "izmir",
          name: "İzmir (Temsili)",
          bins: [
            { t: 4, h: 250 }, { t: 8, h: 700 }, { t: 12, h: 1100 }, { t: 16, h: 1350 },
            { t: 20, h: 1400 }, { t: 24, h: 1250 }, { t: 28, h: 900 }, { t: 32, h: 500 },
            { t: 36, h: 200 }, { t: 40, h: 70 }, { t: 44, h: 20 },
          ],
        },
        {
          key: "frankfurt",
          name: "Frankfurt (Temsili)",
          bins: [
            { t: -6, h: 250 }, { t: -2, h: 450 }, { t: 2, h: 850 }, { t: 6, h: 1200 },
            { t: 10, h: 1400 }, { t: 14, h: 1350 }, { t: 18, h: 1150 }, { t: 22, h: 800 },
            { t: 26, h: 400 }, { t: 30, h: 180 }, { t: 34, h: 70 }, { t: 38, h: 20 },
          ],
        },
      ];

      // Part-load (IPLV-benzeri) COP çarpan eğrisi: PLR -> multiplier
      // Örnek eğri: düşük yükte COP düşer / orta yükte artar / tam yükte 1.0
      // Bu eğriyi saha/üretici datasıyla kalibre edebilirsin.
      function partLoadMultiplier(plr) {
        const x = clamp(plr, 0.1, 1.0);
        // yumuşak bir "kambur": 0.5 civarı en iyi, 0.1 kötü
        // 0.5 -> ~1.08, 1.0 -> 1.0, 0.1 -> ~0.78
        const hump = 1.08 - 0.22 * Math.pow((x - 0.5) / 0.5, 2);
        const lowPenalty = 0.78 + 0.22 * (x / 0.5); // 0.1..0.5 arası yükselir
        return x <= 0.5 ? clamp(lowPenalty, 0.70, 1.10) : clamp(hump, 0.85, 1.10);
      }

      function estimateCOPBase({ oatC, chwSupplyC, condenserApproachC, evapApproachC, copAtRef, refLiftC, copSlopePerC, copMin, copMax }) {
        const Tcond = oatC + condenserApproachC;
        const Tevap = chwSupplyC - evapApproachC;
        const lift = Math.max(1, Tcond - Tevap);
        const cop = clamp(copAtRef - (lift - refLiftC) * copSlopePerC, copMin, copMax);
        return { cop, lift, Tcond, Tevap };
      }

      function modeAtOAT({ oatC, chwSupplyC, fcEnableC, fcApproachC, useAdiabatic, adiabaticGainC }) {
        const effectiveOAT = useAdiabatic ? (oatC - adiabaticGainC) : oatC;
        const canByThreshold = oatC <= fcEnableC;
        const canByThermo = (effectiveOAT + fcApproachC) <= chwSupplyC;
        return (canByThreshold && canByThermo) ? "FC" : "MECH";
      }

      function downloadJSON(filename, obj) {
        const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function InteractiveChart({ data, width=900, height=220 }) {
        // data: [{x, y, mode, copEff, plr}]
        const pad = 30;
        const xs = data.map(d=>d.x);
        const ys = data.map(d=>d.y);
        const xMin = Math.min(...xs), xMax = Math.max(...xs);
        const yMin = 0;
        const yMax = Math.max(...ys) * 1.08;

        const xScale = (x) => pad + ((x-xMin)/(xMax-xMin || 1))*(width-pad*2);
        const yScale = (y) => height-pad - ((y-yMin)/(yMax-yMin || 1))*(height-pad*2);

        const path = data.map((d,i)=>`${i===0?"M":"L"} ${xScale(d.x)} ${yScale(d.y)}`).join(" ");

        const [hover, setHover] = useState(null);

        const onMove = (evt) => {
          const rect = evt.currentTarget.getBoundingClientRect();
          const mx = evt.clientX - rect.left;
          // nearest x by pixel distance
          let best = data[0], bestDx = Math.abs(xScale(best.x)-mx);
          for (const d of data) {
            const dx = Math.abs(xScale(d.x)-mx);
            if (dx < bestDx) { best = d; bestDx = dx; }
          }
          setHover(best);
        };

        const fcTicks = data.filter(d=>d.mode==="FC");

        return (
          <div style={{position:"relative"}}>
            <svg
              width={width}
              height={height}
              style={{maxWidth:"100%", display:"block"}}
              onMouseMove={onMove}
              onMouseLeave={()=>setHover(null)}
            >
              <rect x="0" y="0" width={width} height={height} fill="transparent" stroke="currentColor" opacity="0.12"/>
              {/* FC bölgesini hafif band olarak göster */}
              {fcTicks.length>0 && (
                (() => {
                  const xsFC = fcTicks.map(d=>d.x);
                  const a = Math.min(...xsFC), b = Math.max(...xsFC);
                  return (
                    <rect x={xScale(a)} y={pad/2} width={xScale(b)-xScale(a)} height={height-pad}
                      fill="currentColor" opacity="0.04" />
                  );
                })()
              )}
              <path d={path} fill="none" stroke="currentColor" strokeWidth="2"/>

              {/* Hover noktası */}
              {hover && (
                <>
                  <line x1={xScale(hover.x)} y1={pad/2} x2={xScale(hover.x)} y2={height-pad}
                    stroke="currentColor" opacity="0.18" />
                  <circle cx={xScale(hover.x)} cy={yScale(hover.y)} r="4" fill="currentColor" />
                </>
              )}

              {/* FC tick baseline */}
              {data.filter(d=>d.mode==="FC").map((d,i)=>(
                <line key={i} x1={xScale(d.x)} y1={height-pad} x2={xScale(d.x)} y2={height-pad-10}
                  stroke="currentColor" strokeWidth="1" opacity="0.35" />
              ))}

              {/* Eksen etiketleri */}
              <text x={pad} y={18} fontSize="12" opacity="0.8">kW (cooling power) vs OAT • FC band & tooltip</text>
              <text x={pad} y={height-8} fontSize="11" opacity="0.65">{xMin}°C</text>
              <text x={width-pad-34} y={height-8} fontSize="11" opacity="0.65">{xMax}°C</text>
            </svg>

            {hover && (
              <div style={{
                position:"absolute",
                left: 10,
                top: 36,
                background:"#fff",
                border:"1px solid rgba(0,0,0,.14)",
                borderRadius:12,
                padding:"8px 10px",
                fontSize:12,
                boxShadow:"0 6px 18px rgba(0,0,0,.08)"
              }}>
                <div><b>OAT:</b> <span className="mono">{hover.x}°C</span> • <b>Mode:</b> <span className="mono">{hover.mode}</span></div>
                <div><b>Cooling kW:</b> <span className="mono">{round(hover.y,1)}</span></div>
                <div><b>PLR:</b> <span className="mono">{round(hover.plr,2)}</span> • <b>COP eff:</b> <span className="mono">{round(hover.copEff,2)}</span></div>
              </div>
            )}
          </div>
        );
      }

      function makeScenarioDefaults() {
        return {
          name: "Scenario",
          // Loads
          itLoadkW: 1000,
          avgUtilPct: 65,
          otherFacilitykW: 60,

          coolingLoadMode: "IT_MULT", // IT_MULT or FIXED
          coolingOverheadPct: 6,
          fixedCoolingkW: 850,

          // Water temps
          chwSupplyC: 15,
          chwReturnC: 20,

          condenserApproachC: 10,
          evapApproachC: 4,

          // Aux powers
          pumpPowerPct: 2.2,
          fanPowerPct: 1.4,
          hxPenaltyPct: 1.2,

          // COP base model
          copAtRef: 5.2,
          refLiftC: 28,
          copSlopePerC: 0.06,
          copMin: 1.8,
          copMax: 7.5,

          // Part load
          enablePartLoad: true,
          designCoolingkW: 1200, // chiller plant nominal cooling capacity for PLR (kWth)
          minPLR: 0.15,          // min stable plr for compressors (rough)

          // Free cooling
          fcEnableC: 18,
          fcApproachC: 4.5,
          useAdiabatic: false,
          adiabaticGainC: 6,

          // Climate
          climateMode: "PRESET",
          cityKey: "istanbul",
          csvText: "",
          csvHoursScale: 8760,

          // Simulation
          tMin: -10, tMax: 50, tStep: 1,

          // Economics
          tariff: 0.12,           // $/kWh (örnek)
          capexDelta: 0,          // Scenario’ya özel ek yatırım (A-B karşılaştırma)
        };
      }

      function validateScenario(s) {
        const warnings = [];
        if (s.chwReturnC <= s.chwSupplyC) warnings.push("CHW Return, Supply’dan büyük olmalı (ΔT > 0).");
        if (s.chwSupplyC < 4) warnings.push("CHW Supply çok düşük (4°C altı). FC penceresi daralır; donma/coil riski olabilir.");
        if (s.chwSupplyC > 22) warnings.push("CHW Supply çok yüksek. IT ekipmanı/coil tasarımı uygun mu kontrol et.");
        if (s.fcApproachC < 2) warnings.push("FC approach çok iyimser (<2°C). Dry cooler + HX toplam yaklaşımı genelde daha yüksek olur.");
        if (s.condenserApproachC < 6) warnings.push("Condenser approach çok iyimser (<6°C). Seçim datasıyla doğrula.");
        if (s.evapApproachC < 2) warnings.push("Evap approach çok iyimser (<2°C).");
        if (s.tariff <= 0) warnings.push("Enerji birim fiyatı (tarife) 0 veya negatif olamaz.");
        if (s.enablePartLoad && s.designCoolingkW <= 0) warnings.push("Part-load için Design Cooling kW > 0 olmalı.");
        if (s.enablePartLoad && (s.minPLR < 0.05 || s.minPLR > 0.5)) warnings.push("Min PLR makul aralıkta olsun (0.05–0.5).");
        return warnings;
      }

      function computeAnnual(s) {
        const itAvgkW = s.itLoadkW * (s.avgUtilPct/100);

        const coolingLoadkW = (s.coolingLoadMode==="FIXED")
          ? Math.max(0, s.fixedCoolingkW)
          : itAvgkW * (1 + s.coolingOverheadPct/100);

        const profile = (() => {
          if (s.climateMode==="PRESET") {
            const city = CITY_PROFILES.find(c=>c.key===s.cityKey) || CITY_PROFILES[0];
            return { type:"bins", name: city.name, bins: city.bins };
          }
          return { type:"csv", name:"CSV", temps: parseCSVTemps(s.csvText) };
        })();

        const pointAtTemp = (oatC) => {
          const mode = modeAtOAT({
            oatC,
            chwSupplyC: s.chwSupplyC,
            fcEnableC: s.fcEnableC,
            fcApproachC: s.fcApproachC,
            useAdiabatic: s.useAdiabatic,
            adiabaticGainC: s.adiabaticGainC,
          });

          const plrRaw = s.enablePartLoad ? (coolingLoadkW / Math.max(1e-6, s.designCoolingkW)) : 1.0;
          const plr = s.enablePartLoad ? clamp(plrRaw, s.minPLR, 1.0) : 1.0;
          const plMult = s.enablePartLoad ? partLoadMultiplier(plr) : 1.0;

          let kWcool = 0;
          let copEff = 0;

          if (mode==="FC") {
            const pump = (s.pumpPowerPct/100) * coolingLoadkW;
            const fan  = (s.fanPowerPct/100) * coolingLoadkW;
            const hx   = (s.hxPenaltyPct/100) * coolingLoadkW;
            kWcool = pump + fan + hx;
            copEff = Infinity;
          } else {
            const base = estimateCOPBase({
              oatC,
              chwSupplyC: s.chwSupplyC,
              condenserApproachC: s.condenserApproachC,
              evapApproachC: s.evapApproachC,
              copAtRef: s.copAtRef,
              refLiftC: s.refLiftC,
              copSlopePerC: s.copSlopePerC,
              copMin: s.copMin,
              copMax: s.copMax,
            });
            const copEffLocal = base.cop * plMult;
            copEff = copEffLocal;
            const compressor = coolingLoadkW / Math.max(0.1, copEffLocal);
            const pump = (s.pumpPowerPct/100) * coolingLoadkW;
            const fan  = (s.fanPowerPct/100) * coolingLoadkW;
            kWcool = compressor + pump + fan;
          }

          return { mode, plr, copEff: Number.isFinite(copEff) ? copEff : 999, kWcool };
        };

        // Curve for chart
        const curve = [];
        for (let t=s.tMin; t<=s.tMax; t+=s.tStep) {
          const p = pointAtTemp(t);
          curve.push({ x: t, y: p.kWcool, mode: p.mode, copEff: p.copEff, plr: p.plr });
        }

        // Annual aggregation
        const itAvgkW = s.itLoadkW * (s.avgUtilPct/100);
        let totalHours = 0, fcHours = 0, mechHours = 0;
        let E_total = 0, E_it = 0, E_cool = 0;

        const monthly = MONTH_WEIGHTS.map(m=>({ m: m.m, E_cool: 0, E_total: 0, fcH: 0, mechH: 0 }));

        if (profile.type==="bins") {
          for (const b of profile.bins) {
            const p = pointAtTemp(b.t);
            totalHours += b.h;
            if (p.mode==="FC") fcHours += b.h; else mechHours += b.h;

            const Ptotal = itAvgkW + p.kWcool + s.otherFacilitykW;

            E_total += Ptotal * b.h;
            E_it    += itAvgkW * b.h;
            E_cool  += p.kWcool * b.h;
          }
          for (let i=0; i<monthly.length; i++) {
            monthly[i].E_cool = E_cool * MONTH_WEIGHTS[i].w;
            monthly[i].E_total = E_total * MONTH_WEIGHTS[i].w;
            monthly[i].fcH = fcHours * MONTH_WEIGHTS[i].w;
            monthly[i].mechH = mechHours * MONTH_WEIGHTS[i].w;
          }
        } else {
          const temps = profile.temps || [];
          const n = temps.length;
          if (n>0) {
            const scale = s.csvHoursScale / n;
            for (let i=0; i<n; i++) {
              const p = pointAtTemp(temps[i]);
              totalHours += scale;
              if (p.mode==="FC") fcHours += scale; else mechHours += scale;

              const Ptotal = itAvgkW + p.kWcool + s.otherFacilitykW;

              E_total += Ptotal * scale;
              E_it    += itAvgkW * scale;
              E_cool  += p.kWcool * scale;
            }
            for (let i=0; i<monthly.length; i++) {
              monthly[i].E_cool = E_cool * MONTH_WEIGHTS[i].w;
              monthly[i].E_total = E_total * MONTH_WEIGHTS[i].w;
              monthly[i].fcH = fcHours * MONTH_WEIGHTS[i].w;
              monthly[i].mechH = mechHours * MONTH_WEIGHTS[i].w;
            }
          }
        }

        const pue = E_total / Math.max(1e-9, E_it);
        const costTotal = E_total * s.tariff;
        const costCooling = E_cool * s.tariff;

        return {
          itAvgkW,
          coolingLoadkW,
          profileName: profile.name,
          totalHours, fcHours, mechHours,
          fcSharePct: (fcHours / Math.max(1, totalHours)) * 100,
          E_total, E_it, E_cool,
          pue,
          costTotal, costCooling,
          curve,
          monthly,
        };
      }

      function ScenarioEditor({ s, setS, compact=false }) {
        const w = validateScenario(s);

        const Info = ({text}) => (<span className="tooltip" title={text}>i</span>);

        const set = (k, v) => setS({ ...s, [k]: v });

        return (
          <div>
            {w.length>0 ? (
              <div className="warn" style={{marginBottom:10}}>
                <div style={{fontWeight:900, marginBottom:6}}>Uyarılar</div>
                <ul style={{margin:0, paddingLeft:18}}>
                  {w.map((x,i)=><li key={i}>{x}</li>)}
                </ul>
              </div>
            ) : (
              <div className="ok" style={{marginBottom:10}}>
                <div style={{fontWeight:900}}>Girdi kontrolleri: OK</div>
                <div className="small">Model varsayımsal; üretici datası ile kalibre edince çok güçlenir.</div>
              </div>
            )}

            <div className="grid">
              <div className={compact ? "card12" : "card"}>
                <div className="title">Yükler <Info text="IT ortalama yük + soğutma overhead veya sabit soğutma kW."/></div>
                <div className="row">
                  <div>
                    <div className="label">IT Kurulu Güç (kW)</div>
                    <input type="number" value={s.itLoadkW} onChange={e=>set("itLoadkW", Number(e.target.value))}/>
                  </div>
                  <div>
                    <div className="label">Avg Util (%)</div>
                    <input type="number" value={s.avgUtilPct} onChange={e=>set("avgUtilPct", Number(e.target.value))}/>
                  </div>
                </div>
                <div className="row">
                  <div>
                    <div className="label">Diğer Tesis (kW)</div>
                    <input type="number" value={s.otherFacilitykW} onChange={e=>set("otherFacilitykW", Number(e.target.value))}/>
                  </div>
                  <div>
                    <div className="label">Soğutma Modeli</div>
                    <select value={s.coolingLoadMode} onChange={e=>set("coolingLoadMode", e.target.value)}>
                      <option value="IT_MULT">IT’e bağlı</option>
                      <option value="FIXED">Sabit</option>
                    </select>
                  </div>
                </div>
                {s.coolingLoadMode==="IT_MULT" ? (
                  <div className="row">
                    <div>
                      <div className="label">Cooling Overhead (%)</div>
                      <input type="number" value={s.coolingOverheadPct} onChange={e=>set("coolingOverheadPct", Number(e.target.value))}/>
                      <div className="small">IT üstüne ek ısı.</div>
                    </div>
                    <div>
                      <div className="label">Fixed Cooling (kW)</div>
                      <input type="number" value={s.fixedCoolingkW} disabled />
                    </div>
                  </div>
                ) : (
                  <div className="row">
                    <div>
                      <div className="label">Fixed Cooling (kW)</div>
                      <input type="number" value={s.fixedCoolingkW} onChange={e=>set("fixedCoolingkW", Number(e.target.value))}/>
                    </div>
                    <div>
                      <div className="label">Overhead (%)</div>
                      <input type="number" value={s.coolingOverheadPct} disabled />
                    </div>
                  </div>
                )}
              </div>

              <div className={compact ? "card12" : "card"}>
                <div className="title">Su Sıcaklıkları <Info text="ASHRAE sınıfı / coil tasarımı ile uyumlu supply/return seç."/></div>
                <div className="row">
                  <div>
                    <div className="label">CHW Supply (°C)</div>
                    <input type="number" value={s.chwSupplyC} onChange={e=>set("chwSupplyC", Number(e.target.value))}/>
                  </div>
                  <div>
                    <div className="label">CHW Return (°C)</div>
                    <input type="number" value={s.chwReturnC} onChange={e=>set("chwReturnC", Number(e.target.value))}/>
                  </div>
                </div>
                <div className="row">
                  <div>
                    <div className="label">Evap Approach (°C)</div>
                    <input type="number" value={s.evapApproachC} onChange={e=>set("evapApproachC", Number(e.target.value))}/>
                  </div>
                  <div>
                    <div className="label">Cond. Approach (°C)</div>
                    <input type="number" value={s.condenserApproachC} onChange={e=>set("condenserApproachC", Number(e.target.value))}/>
                  </div>
                </div>
              </div>

              <div className={compact ? "card12" : "card"}>
                <div className="title">Free Cooling <Info text="FC enable eşiği + termodinamik koşul (OAT + approach ≤ CHW)."/></div>
                <div className="row">
                  <div>
                    <div className="label">FC Enable (OAT ≤ …) °C</div>
                    <input type="number" value={s.fcEnableC} onChange={e=>set("fcEnableC", Number(e.target.value))}/>
                  </div>
                  <div>
                    <div className="label">FC Approach (°C)</div>
                    <input type="number" value={s.fcApproachC} onChange={e=>set("fcApproachC", Number(e.target.value))}/>
                  </div>
                </div>
                <div className="row">
                  <div>
                    <div className="label">Adiabatic</div>
                    <select value={s.useAdiabatic ? "YES":"NO"} onChange={e=>set("useAdiabatic", e.target.value==="YES")}>
                      <option value="NO">Yok</option>
                      <option value="YES">Var</option>
                    </select>
                  </div>
                  <div>
                    <div className="label">Adiabatic Gain (°C)</div>
                    <input type="number" value={s.adiabaticGainC} disabled={!s.useAdiabatic} onChange={e=>set("adiabaticGainC", Number(e.target.value))}/>
                  </div>
                </div>
              </div>

              <div className={compact ? "card12" : "card"}>
                <div className="title">Part-Load & COP <Info text="IPLV-benzeri PLR çarpanı ile efektif COP hesaplanır."/></div>
                <div className="row">
                  <div>
                    <div className="label">Part-Load aktif</div>
                    <select value={s.enablePartLoad ? "YES":"NO"} onChange={e=>set("enablePartLoad", e.target.value==="YES")}>
                      <option value="YES">Evet</option>
                      <option value="NO">Hayır</option>
                    </select>
                    <div className="small">Evet ise PLR = Load / DesignCapacity.</div>
                  </div>
                  <div>
                    <div className="label">Design Cooling (kWth)</div>
                    <input type="number" value={s.designCoolingkW} onChange={e=>set("designCoolingkW", Number(e.target.value))}/>
                  </div>
                </div>
                <div className="row">
                  <div>
                    <div className="label">Min PLR</div>
                    <input type="number" step="0.01" value={s.minPLR} onChange={e=>set("minPLR", Number(e.target.value))}/>
                  </div>
                  <div>
                    <div className="label">COP@Ref</div>
                    <input type="number" step="0.1" value={s.copAtRef} onChange={e=>set("copAtRef", Number(e.target.value))}/>
                  </div>
                </div>
                <div className="row">
                  <div>
                    <div className="label">Ref Lift (°C)</div>
                    <input type="number" value={s.refLiftC} onChange={e=>set("refLiftC", Number(e.target.value))}/>
                  </div>
                  <div>
                    <div className="label">COP slope /°C</div>
                    <input type="number" step="0.01" value={s.copSlopePerC} onChange={e=>set("copSlopePerC", Number(e.target.value))}/>
                  </div>
                </div>
              </div>

              <div className={compact ? "card12" : "card"}>
                <div className="title">Yardımcılar & Ekonomi <Info text="Pompa/fan HX cezaları + tarife + capex farkı geri ödeme."/></div>
                <div className="row">
                  <div>
                    <div className="label">Pompa (% load)</div>
                    <input type="number" value={s.pumpPowerPct} onChange={e=>set("pumpPowerPct", Number(e.target.value))}/>
                  </div>
                  <div>
                    <div className="label">Fan (% load)</div>
                    <input type="number" value={s.fanPowerPct} onChange={e=>set("fanPowerPct", Number(e.target.value))}/>
                  </div>
                </div>
                <div className="row">
                  <div>
                    <div className="label">FC HX cezası (% load)</div>
                    <input type="number" value={s.hxPenaltyPct} onChange={e=>set("hxPenaltyPct", Number(e.target.value))}/>
                  </div>
                  <div>
                    <div className="label">Tarife ($/kWh)</div>
                    <input type="number" step="0.01" value={s.tariff} onChange={e=>set("tariff", Number(e.target.value))}/>
                  </div>
                </div>
                <div className="row">
                  <div>
                    <div className="label">CAPEX farkı ($)</div>
                    <input type="number" value={s.capexDelta} onChange={e=>set("capexDelta", Number(e.target.value))}/>
                    <div className="small">Örn: adiabatic ek yatırım / daha büyük dry cooler.</div>
                  </div>
                  <div>
                    <div className="label">Kompresör COP min/max</div>
                    <div className="row3">
                      <input type="number" step="0.1" value={s.copMin} onChange={e=>set("copMin", Number(e.target.value))}/>
                      <input type="number" step="0.1" value={s.copMax} onChange={e=>set("copMax", Number(e.target.value))}/>
                      <input type="number" value={s.evapApproachC} disabled />
                    </div>
                  </div>
                </div>
              </div>

              <div className="card12">
                <div className="title">İklim & Simülasyon <Info text="Preset bin veya CSV saatlik sıcaklık; eğri aralığı -10..50."/></div>
                <div className="row">
                  <div>
                    <div className="label">İklim Modu</div>
                    <select value={s.climateMode} onChange={e=>set("climateMode", e.target.value)}>
                      <option value="PRESET">Şehir preset (temsili)</option>
                      <option value="CSV">CSV/saatlik yapıştır</option>
                    </select>
                  </div>
                  <div>
                    <div className="label">Aralık (Tmin/Tmax/Step)</div>
                    <div className="row3">
                      <input type="number" value={s.tMin} onChange={e=>set("tMin", Number(e.target.value))}/>
                      <input type="number" value={s.tMax} onChange={e=>set("tMax", Number(e.target.value))}/>
                      <input type="number" value={s.tStep} onChange={e=>set("tStep", Number(e.target.value))}/>
                    </div>
                  </div>
                </div>

                {s.climateMode==="PRESET" ? (
                  <div className="row">
                    <div>
                      <div className="label">Şehir</div>
                      <select value={s.cityKey} onChange={e=>set("cityKey", e.target.value)}>
                        {CITY_PROFILES.map(c=><option key={c.key} value={c.key}>{c.name}</option>)}
                      </select>
                      <div className="small">Preset temsili; gerçek proje için CSV önerilir.</div>
                    </div>
                    <div>
                      <div className="label">CSV saat ölçeği</div>
                      <input type="number" value={s.csvHoursScale} disabled />
                    </div>
                  </div>
                ) : (
                  <div className="row">
                    <div>
                      <div className="label">CSV Sıcaklıklar</div>
                      <textarea value={s.csvText} onChange={e=>set("csvText", e.target.value)} placeholder={"12.3\\n11.8\\n... veya: 2025-01-01, 8.2"} />
                      <div className="small">Sadece sayıları ayıklar. (Tarih/saat yazsan da olur.)</div>
                    </div>
                    <div>
                      <div className="label">Saat hedefi (8760)</div>
                      <input type="number" value={s.csvHoursScale} onChange={e=>set("csvHoursScale", Number(e.target.value))}/>
                      <div className="small">CSV satır sayısı 8760 değilse ölçekler.</div>
                      <div className="pill" style={{marginTop:10}}>Algılanan: <span className="mono">{parseCSVTemps(s.csvText).length}</span></div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      function MonthlyTable({ rows }) {
        return (
          <div style={{overflowX:"auto"}}>
            <table style={{width:"100%", borderCollapse:"collapse", fontSize:12}}>
              <thead>
                <tr style={{textAlign:"left"}}>
                  <th style={{padding:"8px 6px", borderBottom:"1px solid rgba(0,0,0,.12)"}}>Ay</th>
                  <th style={{padding:"8px 6px", borderBottom:"1px solid rgba(0,0,0,.12)"}} className="right">Cooling (MWh)</th>
                  <th style={{padding:"8px 6px", borderBottom:"1px solid rgba(0,0,0,.12)"}} className="right">Total (MWh)</th>
                  <th style={{padding:"8px 6px", borderBottom:"1px solid rgba(0,0,0,.12)"}} className="right">FC saat</th>
                  <th style={{padding:"8px 6px", borderBottom:"1px solid rgba(0,0,0,.12)"}} className="right">Mech saat</th>
                </tr>
              </thead>
              <tbody>
                {rows.map((r,i)=>(
                  <tr key={i}>
                    <td style={{padding:"8px 6px", borderBottom:"1px solid rgba(0,0,0,.08)"}}><b>{r.m}</b></td>
                    <td style={{padding:"8px 6px", borderBottom:"1px solid rgba(0,0,0,.08)"}} className="right">{round(r.E_cool/1000,1)}</td>
                    <td style={{padding:"8px 6px", borderBottom:"1px solid rgba(0,0,0,.08)"}} className="right">{round(r.E_total/1000,1)}</td>
                    <td style={{padding:"8px 6px", borderBottom:"1px solid rgba(0,0,0,.08)"}} className="right">{round(r.fcH,0)}</td>
                    <td style={{padding:"8px 6px", borderBottom:"1px solid rgba(0,0,0,.08)"}} className="right">{round(r.mechH,0)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      function App() {
        const [tab, setTab] = useState("compare");

        const [A, setA] = useState({ ...makeScenarioDefaults(), name: "Senaryo A" });
        const [B, setB] = useState({ ...makeScenarioDefaults(), name: "Senaryo B", useAdiabatic: true, capexDelta: 25000 });

        const [ioText, setIoText] = useState("");

        const resA = useMemo(()=>computeAnnual(A), [A]);
        const resB = useMemo(()=>computeAnnual(B), [B]);

        const savingsTotal = resA.costTotal - resB.costTotal;
        const capexDiff = (B.capexDelta - A.capexDelta);
        const paybackYears = savingsTotal > 0 ? (capexDiff / savingsTotal) : Infinity;

        const topBadge = (
          <div className="badge">
            <b>PUE A:</b> <span className="mono">{round(resA.pue,3)}</span> • <b>PUE B:</b> <span className="mono">{round(resB.pue,3)}</span>
            &nbsp;• <b>FC% A:</b> <span className="mono">{round(resA.fcSharePct,1)}%</span> • <b>FC% B:</b> <span className="mono">{round(resB.fcSharePct,1)}%</span>
          </div>
        );

        const exportAll = () => downloadJSON("dc-cooling-pro-scenarios.json", { A, B });

        const importAll = () => {
          try {
            const obj = JSON.parse(ioText);
            if (obj.A) setA(obj.A);
            if (obj.B) setB(obj.B);
            alert("Import OK");
          } catch (e) {
            alert("JSON parse hatası: " + e.message);
          }
        };

        const copyExportText = () => setIoText(JSON.stringify({ A, B }, null, 2));

        return (
          <div className="wrap">
            <div className="header">
              <div>
                <h1>DC Cooling Pro — PUE • Free Cooling • Part-Load • Scenario Compare</h1>
                <div className="sub">Tek dosya “artifact” formatı: CDN React + Babel. (Import yok, npm yok.)</div>
              </div>
              {topBadge}
            </div>

            <div className="tabs">
              <button className={"tabBtn "+(tab==="compare"?"active":"")} onClick={()=>setTab("compare")}>Karşılaştır</button>
              <button className={"tabBtn "+(tab==="scenarioA"?"active":"")} onClick={()=>setTab("scenarioA")}>Senaryo A</button>
              <button className={"tabBtn "+(tab==="scenarioB"?"active":"")} onClick={()=>setTab("scenarioB")}>Senaryo B</button>
              <button className={"tabBtn "+(tab==="io"?"active":"")} onClick={()=>setTab("io")}>Import / Export</button>
              <button className={"tabBtn "+(tab==="report"?"active":"")} onClick={()=>setTab("report")}>Rapor</button>
            </div>

            {tab==="compare" && (
              <div className="grid">
                <div className="card12">
                  <div className="title">
                    KPI Karşılaştırma <span className="pill">A: {resA.profileName}</span> <span className="pill">B: {resB.profileName}</span>
                  </div>

                  <div className="kpiGrid">
                    <div className="kpi">
                      <div className="kpiLbl">PUE (ortalama)</div>
                      <div className="kpiVal">{round(resA.pue,3)} → {round(resB.pue,3)}</div>
                      <div className="small">Düşüş: <span className="mono">{round(resA.pue-resB.pue,3)}</span></div>
                    </div>
                    <div className="kpi">
                      <div className="kpiLbl">Yıllık Toplam Enerji</div>
                      <div className="kpiVal">{round(resA.E_total/1000,1)} → {round(resB.E_total/1000,1)} MWh</div>
                      <div className="small">Δ: <span className="mono">{round((resA.E_total-resB.E_total)/1000,1)} MWh</span></div>
                    </div>
                    <div className="kpi">
                      <div className="kpiLbl">Soğutma Enerjisi</div>
                      <div className="kpiVal">{round(resA.E_cool/1000,1)} → {round(resB.E_cool/1000,1)} MWh</div>
                      <div className="small">Δ: <span className="mono">{round((resA.E_cool-resB.E_cool)/1000,1)} MWh</span></div>
                    </div>
                    <div className="kpi">
                      <div className="kpiLbl">FC Payı</div>
                      <div className="kpiVal">{round(resA.fcSharePct,1)}% → {round(resB.fcSharePct,1)}%</div>
                      <div className="small">FC saat: <span className="mono">{round(resA.fcHours,0)}</span> → <span className="mono">{round(resB.fcHours,0)}</span></div>
                    </div>
                  </div>

                  <div style={{marginTop:12}} className="kpiGrid2">
                    <div className="kpi">
                      <div className="kpiLbl">Yıllık Enerji Maliyeti</div>
                      <div className="kpiVal">${round(resA.costTotal,0)} → ${round(resB.costTotal,0)}</div>
                      <div className="small">Tasarruf (B): <span className="mono">${round(savingsTotal,0)}/yıl</span></div>
                    </div>
                    <div className="kpi">
                      <div className="kpiLbl">Basit Geri Ödeme</div>
                      <div className="kpiVal">{Number.isFinite(paybackYears) ? round(paybackYears,2) + " yıl" : "—"}</div>
                      <div className="small">CAPEX farkı (B-A): <span className="mono">${round(capexDiff,0)}</span></div>
                    </div>
                  </div>
                </div>

                <div className="card12">
                  <div className="title">Interaktif Grafik (A ve B)</div>
                  <div className="small" style={{marginBottom:8}}>Hover ile OAT, mod, PLR ve efektif COP’yi görürsün. Açık band = FC bölgesi.</div>
                  <div className="grid">
                    <div className="card">
                      <div className="title">{A.name} • Cooling kW</div>
                      <InteractiveChart data={resA.curve} />
                    </div>
                    <div className="card">
                      <div className="title">{B.name} • Cooling kW</div>
                      <InteractiveChart data={resB.curve} />
                    </div>
                  </div>
                </div>
              </div>
            )}

            {tab==="scenarioA" && (
              <div className="card12">
                <div className="title">
                  {A.name} Ayarları <span className="pill">Profil: {resA.profileName}</span>
                  <span className="pill">PUE: {round(resA.pue,3)}</span>
                  <span className="pill">FC%: {round(resA.fcSharePct,1)}%</span>
                </div>
                <ScenarioEditor s={A} setS={setA} compact />
              </div>
            )}

            {tab==="scenarioB" && (
              <div className="card12">
                <div className="title">
                  {B.name} Ayarları <span className="pill">Profil: {resB.profileName}</span>
                  <span className="pill">PUE: {round(resB.pue,3)}</span>
                  <span className="pill">FC%: {round(resB.fcSharePct,1)}%</span>
                </div>
                <ScenarioEditor s={B} setS={setB} compact />
              </div>
            )}

            {tab==="io" && (
              <div className="grid">
                <div className="card4">
                  <div className="title">Export / Import</div>
                  <button className="btn primary" onClick={exportAll} style={{width:"100%", marginBottom:8}}>JSON Download (A+B)</button>
                  <button className="btn" onClick={copyExportText} style={{width:"100%", marginBottom:8}}>JSON’u Kutucuğa Yaz</button>
                  <button className="btn" onClick={importAll} style={{width:"100%"}}>Kutucuktan Import</button>
                  <div className="small" style={{marginTop:10}}>Not: iPhone’da dosya indirme davranışı tarayıcıya göre değişebilir. Metin import her zaman çalışır.</div>
                </div>

                <div className="card12" style={{gridColumn:"span 8"}}>
                  <div className="title">JSON</div>
                  <textarea value={ioText} onChange={e=>setIoText(e.target.value)} placeholder='{"A": {...}, "B": {...}}'></textarea>
                </div>
              </div>
            )}

            {tab==="report" && (
              <div className="grid">
                <div className="card12">
                  <div className="title">Detaylı Rapor (Özet)</div>
                  <div className="kpiGrid">
                    <div className="kpi">
                      <div className="kpiLbl">A: Cooling (MWh) / Total (MWh)</div>
                      <div className="kpiVal">{round(resA.E_cool/1000,1)} / {round(resA.E_total/1000,1)}</div>
                      <div className="small">FC saat: <span className="mono">{round(resA.fcHours,0)}</span> • Mech saat: <span className="mono">{round(resA.mechHours,0)}</span></div>
                    </div>
                    <div className="kpi">
                      <div className="kpiLbl">B: Cooling (MWh) / Total (MWh)</div>
                      <div className="kpiVal">{round(resB.E_cool/1000,1)} / {round(resB.E_total/1000,1)}</div>
                      <div className="small">FC saat: <span className="mono">{round(resB.fcHours,0)}</span> • Mech saat: <span className="mono">{round(resB.mechHours,0)}</span></div>
                    </div>
                    <div className="kpi">
                      <div className="kpiLbl">A: Yıllık Maliyet</div>
                      <div className="kpiVal">${round(resA.costTotal,0)}</div>
                    </div>
                    <div className="kpi">
                      <div className="kpiLbl">B: Yıllık Maliyet</div>
                      <div className="kpiVal">${round(resB.costTotal,0)}</div>
                    </div>
                  </div>
                </div>

                <div className="card">
                  <div className="title">Aylık Dağılım — {A.name}</div>
                  <div className="small" style={{marginBottom:8}}>Aylık dağılım “temsili” ağırlıklarla bölünür. CSV ile gerçek aylık breakdown için saatlik timestamp gerekir.</div>
                  <MonthlyTable rows={resA.monthly} />
                </div>

                <div className="card">
                  <div className="title">Aylık Dağılım — {B.name}</div>
                  <div className="small" style={{marginBottom:8}}>Aynı metod. Gerçek rapor için timestamp’li veriyle geliştirebiliriz.</div>
                  <MonthlyTable rows={resB.monthly} />
                </div>

                <div className="card12">
                  <div className="title">Model Notları / Yorum</div>
                  <ul style={{margin:0, paddingLeft:18}} className="small">
                    <li><b>Part-load:</b> PLR = CoolingLoad / DesignCooling. Efektif COP = COP_base × PLR_multiplier.</li>
                    <li><b>FC modu:</b> Kompresör 0 kabul edilir; pompa+fan+HX cezası kalır.</li>
                    <li><b>Ekonomi:</b> Basit geri ödeme = (CAPEX farkı) / (yıllık enerji maliyeti tasarrufu).</li>
                    <li><b>Gerçek seçime yaklaşmak için:</b> Üretici performans noktalarıyla COP modelini kalibre et; dispatch (N+1), min akış ve VFD eğrileri eklenebilir.</li>
                  </ul>
                </div>
              </div>
            )}

            <div className="small" style={{marginTop:14, opacity:.72}}>
              © DC Cooling Pro (konsept analiz). Üretici selection datası + hidronik/dispatch detaylarıyla kalibre edilmelidir.
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
