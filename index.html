<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TermoLoop Pro DC • PUE • Free Cooling • Part‑Load • Scenarios</title>

    <!-- React (Production CDN) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel: JSX'i tarayıcıda derlemek için (tek dosya kolay deploy için). -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root{
        color-scheme: light;
        --bg:#fafafa;
        --card:#ffffff;
        --muted:#667085;
        --text:#111827;
        --border:rgba(0,0,0,.12);
        --border2:rgba(0,0,0,.16);
        --shadow: 0 10px 30px rgba(0,0,0,.06);
        --soft: rgba(0,0,0,.04);
        --soft2: rgba(0,0,0,.06);
        --danger:#b42318;
        --dangerBg: rgba(180,35,24,.08);
        --ok:#027a48;
        --okBg: rgba(2,122,72,.08);
        --brand:#9d1220;          /* TermoLoop red */
        --brand2:#7a0f1a;
      }

      @media (prefers-color-scheme: dark){
        :root{
          color-scheme: dark;
          --bg:#0b0f14;
          --card:#0f172a;
          --muted:#98a2b3;
          --text:#e5e7eb;
          --border:rgba(255,255,255,.10);
          --border2:rgba(255,255,255,.14);
          --shadow: 0 10px 30px rgba(0,0,0,.35);
          --soft: rgba(255,255,255,.05);
          --soft2: rgba(255,255,255,.07);
          --danger:#ff6b6b;
          --dangerBg: rgba(255,107,107,.12);
          --ok:#6ee7b7;
          --okBg: rgba(110,231,183,.10);
          --brand:#ff3b5c;
          --brand2:#ff1f48;
        }
      }

      *{box-sizing:border-box}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: var(--bg);
        color: var(--text);
        line-height:1.35;
      }
      a{color:inherit}

      .wrap{ padding:16px; max-width: 1240px; margin:0 auto; }
      .topbar{
        display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
        margin-bottom:12px;
      }
      .brandRow{ display:flex; align-items:center; gap:10px; }
      .logo{
        width:34px; height:34px; border-radius:10px;
        background: linear-gradient(135deg, var(--brand), var(--brand2));
        box-shadow: var(--shadow);
      }
      h1{ margin:0; font-size:18px; font-weight:950; letter-spacing:.2px; }
      .sub{ font-size:12px; color:var(--muted); margin-top:4px; max-width: 840px; }
      .badge{
        font-size:12px; padding:7px 10px; border:1px solid var(--border);
        border-radius:999px; background: var(--card);
        box-shadow: 0 4px 14px rgba(0,0,0,.04);
      }

      .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 12px; }
      .tabBtn{
        padding:9px 12px; border-radius:12px; border:1px solid var(--border);
        background: var(--card); cursor:pointer; font-weight:850; font-size:13px;
      }
      .tabBtn.active{ background: var(--soft2); border-color: var(--border2); }

      .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; align-items:start; }
      .card{
        grid-column: span 6;
        border:1px solid var(--border);
        border-radius:16px;
        padding:12px;
        background: var(--card);
        box-shadow: var(--shadow);
      }
      .card4{ grid-column: span 4; }
      .card8{ grid-column: span 8; }
      .card12{ grid-column: span 12; }
      .title{
        font-weight:950; margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      }
      .titleLeft{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
      .hint{ font-size:12px; color:var(--muted); font-weight:650; }
      .row{ display:grid; grid-template-columns: 1fr 160px; gap:10px; margin-bottom:10px; }
      .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px; }
      .label{ font-size:12px; color:var(--muted); margin-bottom:4px; font-weight:900; display:flex; gap:6px; align-items:center; }
      input, select, textarea{
        width:100%;
        padding:9px 10px;
        border-radius:12px;
        border:1px solid var(--border2);
        font-size:14px;
        background: transparent;
        color: var(--text);
        outline:none;
      }
      input:focus, select:focus, textarea:focus{
        border-color: rgba(157,18,32,.55);
        box-shadow: 0 0 0 3px rgba(157,18,32,.12);
      }
      textarea{ height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

      .small{ font-size:12px; color:var(--muted); }
      .kpiGrid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
      .kpiGrid2{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
      .kpi{
        border:1px solid var(--border);
        border-radius:14px;
        padding:10px;
        background: linear-gradient(180deg, var(--card), var(--soft));
      }
      .kpiLbl{ font-size:12px; color:var(--muted); font-weight:950; }
      .kpiVal{ font-size:18px; font-weight:1000; margin-top:2px; letter-spacing:.1px; }
      .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

      .btn{
        padding:9px 10px;
        border-radius:12px;
        border:1px solid var(--border);
        background: var(--card);
        cursor:pointer;
        font-weight:900;
        font-size:13px;
      }
      .btn.primary{ background: var(--soft2); border-color: var(--border2); }
      .btn.danger{ border-color: rgba(180,35,24,.35); background: var(--dangerBg); }
      .btnRow{ display:flex; gap:8px; flex-wrap:wrap; }

      .pill{
        font-size:12px; padding:5px 9px;
        border:1px solid var(--border); border-radius:999px; background: var(--card);
        color: var(--text);
      }

      .panel{
        border:1px solid var(--border);
        background: var(--soft);
        padding:10px;
        border-radius:14px;
      }
      .warn{
        border:1px solid rgba(180,35,24,.30);
        background: var(--dangerBg);
        padding:10px;
        border-radius:14px;
      }
      .ok{
        border:1px solid rgba(2,122,72,.30);
        background: var(--okBg);
        padding:10px;
        border-radius:14px;
      }

      .tooltipDot{
        display:inline-flex; align-items:center; justify-content:center;
        width:18px; height:18px; border-radius:999px;
        border:1px solid var(--border2);
        font-size:12px; opacity:.85;
        user-select:none;
      }
      .right{text-align:right}
      .divider{ height:1px; background: var(--border); margin: 10px 0; }

      /* Inline field error */
      .fieldErr{
        margin-top:6px;
        font-size:12px;
        color: var(--danger);
        font-weight:800;
      }
      .isBad{
        border-color: rgba(180,35,24,.55) !important;
        box-shadow: 0 0 0 3px rgba(180,35,24,.12) !important;
      }

      /* Chart */
      .chartWrap{ position:relative; }
      .chartTip{
        position:absolute;
        left: 12px;
        top: 38px;
        background: var(--card);
        border:1px solid var(--border);
        border-radius:14px;
        padding:9px 10px;
        font-size:12px;
        box-shadow: var(--shadow);
        pointer-events:none;
        max-width: 320px;
      }

      @media (max-width: 1040px){
        .card{ grid-column: span 12; }
        .kpiGrid{ grid-template-columns: repeat(2, 1fr); }
        .row{ grid-template-columns: 1fr; }
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState } = React;

      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const round = (v, d = 2) => {
        const p = Math.pow(10, d);
        return Math.round(v * p) / p;
      };
      const safeNum = (v, fallback=0) => {
        const n = Number(v);
        return Number.isFinite(n) ? n : fallback;
      };

      function parseCSVTemps(text) {
        const tokens = String(text||"")
          .replace(/\\r/g, "\\n")
          .split(/[\\n,; \\t]+/)
          .map((s) => s.trim())
          .filter(Boolean);

        const temps = [];
        for (let i = 0; i < tokens.length; i++) {
          const t = Number(tokens[i]);
          if (Number.isFinite(t)) temps.push(t);
        }
        return temps;
      }

      // Temsili aylık ağırlıklar (görsel rapor için; gerçek meteoroloji değildir)
      const MONTH_WEIGHTS = [
        { m: "Oca", w: 0.095 }, { m: "Şub", w: 0.085 }, { m: "Mar", w: 0.085 }, { m: "Nis", w: 0.080 },
        { m: "May", w: 0.080 }, { m: "Haz", w: 0.080 }, { m: "Tem", w: 0.090 }, { m: "Ağu", w: 0.090 },
        { m: "Eyl", w: 0.080 }, { m: "Eki", w: 0.080 }, { m: "Kas", w: 0.075 }, { m: "Ara", w: 0.080 },
      ];

      const CITY_PROFILES = [
        { key:"istanbul", name:"İstanbul (Temsili)",
          bins:[{t:-2,h:80},{t:2,h:400},{t:6,h:900},{t:10,h:1200},{t:14,h:1400},{t:18,h:1300},{t:22,h:1000},{t:26,h:700},{t:30,h:300},{t:34,h:120},{t:38,h:40}]
        },
        { key:"ankara", name:"Ankara (Temsili)",
          bins:[{t:-8,h:250},{t:-2,h:500},{t:2,h:850},{t:6,h:1050},{t:10,h:1200},{t:14,h:1150},{t:18,h:1050},{t:22,h:850},{t:26,h:600},{t:30,h:300},{t:34,h:120},{t:38,h:40}]
        },
        { key:"izmir", name:"İzmir (Temsili)",
          bins:[{t:4,h:250},{t:8,h:700},{t:12,h:1100},{t:16,h:1350},{t:20,h:1400},{t:24,h:1250},{t:28,h:900},{t:32,h:500},{t:36,h:200},{t:40,h:70},{t:44,h:20}]
        },
        { key:"frankfurt", name:"Frankfurt (Temsili)",
          bins:[{t:-6,h:250},{t:-2,h:450},{t:2,h:850},{t:6,h:1200},{t:10,h:1400},{t:14,h:1350},{t:18,h:1150},{t:22,h:800},{t:26,h:400},{t:30,h:180},{t:34,h:70},{t:38,h:20}]
        },
      ];

      // Part-load (IPLV-benzeri) COP multiplier: PLR -> multiplier (kalibrasyon placeholder)
      function partLoadMultiplier(plr) {
        const x = clamp(plr, 0.10, 1.00);
        const low = 0.72 + 0.66*x; // 0.10->0.786 ; 0.50->1.05
        const hi  = 1.08 - 0.16*Math.pow((x-0.55)/0.45,2);
        return x <= 0.55 ? clamp(low, 0.70, 1.12) : clamp(hi, 0.85, 1.12);
      }

      function estimateCOPBase({ oatC, chwSupplyC, condenserApproachC, evapApproachC, copAtRef, refLiftC, copSlopePerC, copMin, copMax }) {
        const Tcond = oatC + condenserApproachC;
        const Tevap = chwSupplyC - evapApproachC;
        const lift = Math.max(1, Tcond - Tevap);
        const cop = clamp(copAtRef - (lift - refLiftC) * copSlopePerC, copMin, copMax);
        return { cop, lift, Tcond, Tevap };
      }

      function modeAtOAT({ oatC, chwSupplyC, fcEnableC, fcApproachC, useAdiabatic, adiabaticGainC }) {
        const effectiveOAT = useAdiabatic ? (oatC - adiabaticGainC) : oatC;
        const canByThreshold = oatC <= fcEnableC;
        const canByThermo = (effectiveOAT + fcApproachC) <= chwSupplyC;
        return (canByThreshold && canByThermo) ? "FC" : "MECH";
      }

      function downloadJSON(filename, obj) {
        const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // “Bu sayfayı HTML olarak indir” (state'i localStorage'a gömerek snapshot)
      function downloadHTMLSnapshot(filename, state) {
        const doc = document.documentElement.outerHTML;
        const marker = "__TERMOLOOP_PRO_DC_SNAPSHOT__";
        const injected = doc.replace(
          "</head>",
          `<script>window.${marker}=${JSON.stringify(state)};try{localStorage.setItem("${marker}",JSON.stringify(window.${marker}));}catch(e){}<\\/script></head>`
        );
        const blob = new Blob([injected], { type: "text/html;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function InteractiveChart({ data, title="Cooling kW vs OAT", width=900, height=240 }) {
        const pad = 34;
        const xs = data.map(d=>d.x);
        const ys = data.map(d=>d.y);
        const xMin = Math.min(...xs), xMax = Math.max(...xs);
        const yMin = 0;
        const yMax = Math.max(...ys) * 1.10;

        const xScale = (x) => pad + ((x-xMin)/(xMax-xMin || 1))*(width-pad*2);
        const yScale = (y) => height-pad - ((y-yMin)/(yMax-yMin || 1))*(height-pad*2);

        const path = data.map((d,i)=>`${i===0?"M":"L"} ${xScale(d.x)} ${yScale(d.y)}`).join(" ");

        const [hover, setHover] = useState(null);

        const onMove = (evt) => {
          const rect = evt.currentTarget.getBoundingClientRect();
          const mx = evt.clientX - rect.left;
          let best = data[0], bestDx = Math.abs(xScale(best.x)-mx);
          for (const d of data) {
            const dx = Math.abs(xScale(d.x)-mx);
            if (dx < bestDx) { best = d; bestDx = dx; }
          }
          setHover(best);
        };

        const xsFC = data.filter(d=>d.mode==="FC").map(d=>d.x);
        const hasFC = xsFC.length>0;
        const fcA = hasFC ? Math.min(...xsFC) : null;
        const fcB = hasFC ? Math.max(...xsFC) : null;

        const yTicks = 4;
        const xTicks = 6;
        const yVals = Array.from({length:yTicks+1}, (_,i)=> yMin + (i*(yMax-yMin)/yTicks));
        const xVals = Array.from({length:xTicks+1}, (_,i)=> xMin + (i*(xMax-xMin)/xTicks));

        return (
          <div className="chartWrap">
            <svg
              width={width}
              height={height}
              style={{maxWidth:"100%", display:"block"}}
              onMouseMove={onMove}
              onMouseLeave={()=>setHover(null)}
            >
              <rect x="0" y="0" width={width} height={height} fill="transparent" stroke="currentColor" opacity="0.12"/>

              {hasFC && (
                <rect
                  x={xScale(fcA)} y={pad/2}
                  width={Math.max(2, xScale(fcB)-xScale(fcA))}
                  height={height-pad}
                  fill="currentColor" opacity="0.05"
                />
              )}

              {yVals.map((v,i)=>(
                <g key={"y"+i} opacity="0.12">
                  <line x1={pad} y1={yScale(v)} x2={width-pad} y2={yScale(v)} stroke="currentColor" />
                </g>
              ))}
              {xVals.map((v,i)=>(
                <g key={"x"+i} opacity="0.10">
                  <line x1={xScale(v)} y1={pad/2} x2={xScale(v)} y2={height-pad} stroke="currentColor" />
                </g>
              ))}

              <path d={path} fill="none" stroke="currentColor" strokeWidth="2.2"/>

              {hover && (
                <>
                  <line x1={xScale(hover.x)} y1={pad/2} x2={xScale(hover.x)} y2={height-pad}
                    stroke="currentColor" opacity="0.18" />
                  <circle cx={xScale(hover.x)} cy={yScale(hover.y)} r="4.3" fill="currentColor" />
                </>
              )}

              <text x={pad} y={18} fontSize="12" opacity="0.85">{title}</text>
              <text x={pad} y={height-8} fontSize="11" opacity="0.65">{round(xMin,0)}°C</text>
              <text x={width-pad-38} y={height-8} fontSize="11" opacity="0.65">{round(xMax,0)}°C</text>
              <text x={pad} y={height-pad-8} fontSize="11" opacity="0.60">FC band = kompresör off</text>
            </svg>

            {hover && (
              <div className="chartTip">
                <div><b>OAT:</b> <span className="mono">{hover.x}°C</span> • <b>Mod:</b> <span className="mono">{hover.mode}</span></div>
                <div><b>Cooling power:</b> <span className="mono">{round(hover.y,1)} kW</span></div>
                <div><b>PLR:</b> <span className="mono">{round(hover.plr,2)}</span> • <b>COP eff:</b> <span className="mono">{round(hover.copEff,2)}</span></div>
              </div>
            )}
          </div>
        );
      }

      function StackedModeBar({ fcH, mechH }) {
        const total = Math.max(1e-9, fcH + mechH);
        const fcPct = (fcH/total)*100;
        const mechPct = 100 - fcPct;
        return (
          <div style={{width:"100%"}}>
            <div className="small" style={{display:"flex", justifyContent:"space-between", marginBottom:6}}>
              <span>FC: <span className="mono">{round(fcH,0)} h</span></span>
              <span>MECH: <span className="mono">{round(mechH,0)} h</span></span>
            </div>
            <div style={{
              width:"100%", height:12, borderRadius:999, border:"1px solid var(--border)",
              overflow:"hidden", display:"flex", background:"transparent"
            }}>
              <div style={{width:`${fcPct}%`, background:"currentColor", opacity:0.18}} />
              <div style={{width:`${mechPct}%`, background:"currentColor", opacity:0.06}} />
            </div>
            <div className="small" style={{marginTop:6}}>
              FC payı: <span className="mono">{round(fcPct,1)}%</span>
            </div>
          </div>
        );
      }

      function makeScenarioDefaults() {
        return {
          name: "Scenario",
          itLoadkW: 1000,
          avgUtilPct: 65,
          otherFacilitykW: 60,

          coolingLoadMode: "IT_MULT",
          coolingOverheadPct: 6,
          fixedCoolingkW: 850,

          chwSupplyC: 15,
          chwReturnC: 20,

          condenserApproachC: 10,
          evapApproachC: 4,

          pumpPowerPct: 2.2,
          fanPowerPct: 1.4,
          hxPenaltyPct: 1.2,

          copAtRef: 5.2,
          refLiftC: 28,
          copSlopePerC: 0.06,
          copMin: 1.8,
          copMax: 7.5,

          enablePartLoad: true,
          designCoolingkW: 1200,
          minPLR: 0.15,

          fcEnableC: 18,
          fcApproachC: 4.5,
          useAdiabatic: false,
          adiabaticGainC: 6,

          climateMode: "PRESET",
          cityKey: "istanbul",
          csvText: "",
          csvHoursScale: 8760,

          tMin: -10, tMax: 50, tStep: 1,

          tariff: 0.12,
          capexDelta: 0,
        };
      }

      function validateScenario(s) {
        const warnings = [];
        const fieldErr = {};

        const num = (k, min=null, max=null) => {
          const v = s[k];
          if (!Number.isFinite(v)) { fieldErr[k] = "Sayı olmalı"; return; }
          if (min!==null && v < min) fieldErr[k] = `≥ ${min} olmalı`;
          if (max!==null && v > max) fieldErr[k] = `≤ ${max} olmalı`;
        };

        num("itLoadkW", 0, null);
        num("avgUtilPct", 0, 100);
        num("otherFacilitykW", 0, null);
        num("coolingOverheadPct", 0, 50);
        num("fixedCoolingkW", 0, null);

        num("chwSupplyC", 2, 28);
        num("chwReturnC", 3, 32);
        if (s.chwReturnC <= s.chwSupplyC) {
          warnings.push("CHW Return, Supply’dan büyük olmalı (ΔT > 0).");
          fieldErr["chwReturnC"] = "Return > Supply olmalı";
        }

        num("fcEnableC", -30, 30);
        num("fcApproachC", 1, 15);
        if (s.fcApproachC < 2) warnings.push("FC approach çok iyimser (<2°C). Dry cooler + HX toplam yaklaşımı genelde daha yüksek olur.");

        num("condenserApproachC", 4, 20);
        if (s.condenserApproachC < 6) warnings.push("Condenser approach iyimser (<6°C). Seçim datasıyla doğrula.");
        num("evapApproachC", 2, 12);

        num("pumpPowerPct", 0, 10);
        num("fanPowerPct", 0, 10);
        num("hxPenaltyPct", 0, 10);

        num("copAtRef", 1.5, 12);
        num("refLiftC", 10, 60);
        num("copSlopePerC", 0.0, 0.3);
        num("copMin", 0.8, 6);
        num("copMax", 2, 20);
        if (s.copMax < s.copMin) {
          warnings.push("COP max, COP min’den küçük olamaz.");
          fieldErr["copMax"] = "COP max ≥ COP min";
        }

        if (s.enablePartLoad) {
          num("designCoolingkW", 1, null);
          num("minPLR", 0.05, 0.6);
        }

        num("tariff", 0.00001, null);
        num("capexDelta", 0, null);

        num("tMin", -50, 30);
        num("tMax", 0, 70);
        num("tStep", 0.25, 10);
        if (s.tMax <= s.tMin) {
          warnings.push("Simülasyon aralığı hatalı: Tmax, Tmin’den büyük olmalı.");
          fieldErr["tMax"] = "Tmax > Tmin";
        }

        if (s.climateMode==="CSV") {
          const n = parseCSVTemps(s.csvText).length;
          if (n < 24) warnings.push("CSV sıcaklık sayısı çok az. En az birkaç gün (örn. 72–168) önerilir.");
          if (n === 0) fieldErr["csvText"] = "CSV boş";
        }

        if (s.chwSupplyC < 4) warnings.push("CHW Supply çok düşük (4°C altı). FC penceresi daralır; donma/coil riski olabilir.");
        if (s.chwSupplyC > 22) warnings.push("CHW Supply yüksek. IT ekipmanı/coil tasarımı uygun mu kontrol et.");

        return { warnings, fieldErr };
      }

      function computeAnnual(s) {
        const itAvgkW = s.itLoadkW * (s.avgUtilPct/100);

        const coolingLoadkW = (s.coolingLoadMode==="FIXED")
          ? Math.max(0, s.fixedCoolingkW)
          : itAvgkW * (1 + s.coolingOverheadPct/100);

        const profile = (() => {
          if (s.climateMode==="PRESET") {
            const city = CITY_PROFILES.find(c=>c.key===s.cityKey) || CITY_PROFILES[0];
            return { type:"bins", name: city.name, bins: city.bins };
          }
          return { type:"csv", name:"CSV", temps: parseCSVTemps(s.csvText) };
        })();

        const pointAtTemp = (oatC, hours) => {
          const mode = modeAtOAT({
            oatC,
            chwSupplyC: s.chwSupplyC,
            fcEnableC: s.fcEnableC,
            fcApproachC: s.fcApproachC,
            useAdiabatic: s.useAdiabatic,
            adiabaticGainC: s.adiabaticGainC,
          });

          const plrRaw = s.enablePartLoad ? (coolingLoadkW / Math.max(1e-6, s.designCoolingkW)) : 1.0;
          const plr = s.enablePartLoad ? clamp(plrRaw, s.minPLR, 1.0) : 1.0;
          const plMult = s.enablePartLoad ? partLoadMultiplier(plr) : 1.0;

          let kWcool = 0;
          let copEff = 0;

          if (mode==="FC") {
            const pump = (s.pumpPowerPct/100) * coolingLoadkW;
            const fan  = (s.fanPowerPct/100) * coolingLoadkW;
            const hx   = (s.hxPenaltyPct/100) * coolingLoadkW;
            kWcool = pump + fan + hx;
            copEff = 999;
          } else {
            const base = estimateCOPBase({
              oatC,
              chwSupplyC: s.chwSupplyC,
              condenserApproachC: s.condenserApproachC,
              evapApproachC: s.evapApproachC,
              copAtRef: s.copAtRef,
              refLiftC: s.refLiftC,
              copSlopePerC: s.copSlopePerC,
              copMin: s.copMin,
              copMax: s.copMax,
            });
            const copEffLocal = base.cop * plMult;
            copEff = copEffLocal;

            const compressor = coolingLoadkW / Math.max(0.10, copEffLocal);
            const pump = (s.pumpPowerPct/100) * coolingLoadkW;
            const fan  = (s.fanPowerPct/100) * coolingLoadkW;
            kWcool = compressor + pump + fan;
          }

          const Ptotal = itAvgkW + kWcool + s.otherFacilitykW;

          return { oatC, hours, mode, plr, copEff, kWcool, Ptotal };
        };

        const curveKW = [];
        const curveCOP = [];
        for (let t=s.tMin; t<=s.tMax; t+=s.tStep) {
          const p = pointAtTemp(t, 1);
          curveKW.push({ x: t, y: p.kWcool, mode: p.mode, copEff: p.copEff, plr: p.plr });
          curveCOP.push({ x: t, y: p.copEff, mode: p.mode, copEff: p.copEff, plr: p.plr });
        }

        let totalHours = 0, fcHours = 0, mechHours = 0;
        let E_total = 0, E_it = 0, E_cool = 0;

        const monthly = MONTH_WEIGHTS.map(m=>({ m: m.m, E_cool: 0, E_total: 0, fcH: 0, mechH: 0 }));

        if (profile.type==="bins") {
          for (const b of profile.bins) {
            const p = pointAtTemp(b.t, b.h);
            totalHours += b.h;
            if (p.mode==="FC") fcHours += b.h; else mechHours += b.h;
            E_total += p.Ptotal * b.h;
            E_it    += itAvgkW * b.h;
            E_cool  += p.kWcool * b.h;
          }
          for (let i=0; i<monthly.length; i++) {
            monthly[i].E_cool = E_cool * MONTH_WEIGHTS[i].w;
            monthly[i].E_total = E_total * MONTH_WEIGHTS[i].w;
            monthly[i].fcH = fcHours * MONTH_WEIGHTS[i].w;
            monthly[i].mechH = mechHours * MONTH_WEIGHTS[i].w;
          }
        } else {
          const temps = profile.temps || [];
          const n = temps.length;
          if (n>0) {
            const scale = s.csvHoursScale / n;
            for (let i=0; i<n; i++) {
              const p = pointAtTemp(temps[i], 1);
              totalHours += scale;
              if (p.mode==="FC") fcHours += scale; else mechHours += scale;
              E_total += p.Ptotal * scale;
              E_it    += itAvgkW * scale;
              E_cool  += p.kWcool * scale;
            }
            for (let i=0; i<monthly.length; i++) {
              monthly[i].E_cool = E_cool * MONTH_WEIGHTS[i].w;
              monthly[i].E_total = E_total * MONTH_WEIGHTS[i].w;
              monthly[i].fcH = fcHours * MONTH_WEIGHTS[i].w;
              monthly[i].mechH = mechHours * MONTH_WEIGHTS[i].w;
            }
          }
        }

        const pue = E_total / Math.max(1e-9, E_it);
        const costTotal = E_total * s.tariff;

        return {
          itAvgkW,
          coolingLoadkW,
          profileName: profile.name,
          totalHours, fcHours, mechHours,
          fcSharePct: (fcHours / Math.max(1, totalHours)) * 100,
          E_total, E_it, E_cool,
          pue,
          costTotal,
          curveKW,
          curveCOP,
          monthly,
        };
      }

      function Field({label, tip, children}) {
        return (
          <div>
            <div className="label">
              <span>{label}</span>
              {tip ? <span className="tooltipDot" title={tip}>i</span> : null}
            </div>
            {children}
          </div>
        );
      }

      function ScenarioEditor({ s, setS, compact=false }) {
        const { warnings, fieldErr } = validateScenario(s);
        const set = (k, v) => setS({ ...s, [k]: v });

        const numInput = (k, opts={}) => {
          const { step, disabled } = opts;
          const bad = Boolean(fieldErr[k]);
          return (
            <div>
              <input
                className={bad ? "isBad" : ""}
                type="number"
                step={step}
                value={s[k]}
                disabled={disabled}
                onChange={(e)=>set(k, safeNum(e.target.value, 0))}
              />
              {bad ? <div className="fieldErr">{fieldErr[k]}</div> : null}
            </div>
          );
        };

        return (
          <div>
            {warnings.length>0 ? (
              <div className="warn" style={{marginBottom:10}}>
                <div style={{fontWeight:950, marginBottom:6}}>Validasyon & Uyarılar</div>
                <ul style={{margin:0, paddingLeft:18}}>
                  {warnings.map((x,i)=><li key={i}>{x}</li>)}
                </ul>
                <div className="small" style={{marginTop:6}}>
                  Bu araç “konsept analiz” içindir. Üretici selection datası + hidronik/dispatch detaylarıyla kalibre edilmelidir.
                </div>
              </div>
            ) : (
              <div className="ok" style={{marginBottom:10}}>
                <div style={{fontWeight:950}}>Girdi kontrolleri: OK</div>
                <div className="small">Model varsayımsal; üretici datası ile kalibre edince çok güçlenir.</div>
              </div>
            )}

            <div className="grid">
              <div className={(compact ? "card12 card" : "card")}>
                <div className="title">
                  <div className="titleLeft">Yükler</div>
                  <div className="hint">IT avg + cooling overhead</div>
                </div>

                <div className="row">
                  <Field label="IT Kurulu Güç (kW)" tip="Toplam IT nameplate. Ortalama = Util% ile hesaplanır.">
                    {numInput("itLoadkW")}
                  </Field>
                  <Field label="Avg Util (%)" tip="Yıllık ortalama IT kullanım oranı.">
                    {numInput("avgUtilPct")}
                  </Field>
                </div>

                <div className="row">
                  <Field label="Diğer Tesis (kW)" tip="Aydınlatma, UPS kayıpları, ofis vb. sabit/ortalama.">
                    {numInput("otherFacilitykW")}
                  </Field>
                  <Field label="Soğutma Modeli" tip="Soğutma yükünü IT’e bağlı (overhead) veya sabit al.">
                    <select value={s.coolingLoadMode} onChange={(e)=>set("coolingLoadMode", e.target.value)}>
                      <option value="IT_MULT">IT’e bağlı</option>
                      <option value="FIXED">Sabit</option>
                    </select>
                  </Field>
                </div>

                {s.coolingLoadMode==="IT_MULT" ? (
                  <div className="row">
                    <Field label="Cooling Overhead (%)" tip="IT üstüne ek ısı (fanlar, power, kaçaklar).">
                      {numInput("coolingOverheadPct")}
                      <div className="small">Soğutma yükü = ITavg × (1 + overhead).</div>
                    </Field>
                    <Field label="Fixed Cooling (kW)" tip="Sabit soğutma seçili değilse kilitli.">
                      {numInput("fixedCoolingkW", {disabled:true})}
                    </Field>
                  </div>
                ) : (
                  <div className="row">
                    <Field label="Fixed Cooling (kW)" tip="Sabit soğutma yükü (kWth).">
                      {numInput("fixedCoolingkW")}
                    </Field>
                    <Field label="Overhead (%)" tip="IT’e bağlı değilse kilitli.">
                      {numInput("coolingOverheadPct", {disabled:true})}
                    </Field>
                  </div>
                )}
              </div>

              <div className={(compact ? "card12 card" : "card")}>
                <div className="title">
                  <div className="titleLeft">Su Sıcaklıkları</div>
                  <div className="hint">Supply/Return</div>
                </div>

                <div className="row">
                  <Field label="CHW Supply (°C)" tip="Yüksek supply (örn 15°C) free cooling penceresini büyütür.">
                    {numInput("chwSupplyC")}
                  </Field>
                  <Field label="CHW Return (°C)" tip="Return > Supply olmalı. ΔT düşükse pompa/coil etkilenir.">
                    {numInput("chwReturnC")}
                  </Field>
                </div>

                <div className="row">
                  <Field label="Evap Approach (°C)" tip="Evaporatör yaklaşımı (coil/evap + kontrol).">
                    {numInput("evapApproachC")}
                  </Field>
                  <Field label="Cond. Approach (°C)" tip="Kondenser yaklaşımı (dry cooler/CT + HX).">
                    {numInput("condenserApproachC")}
                  </Field>
                </div>
              </div>

              <div className={(compact ? "card12 card" : "card")}>
                <div className="title">
                  <div className="titleLeft">Free Cooling</div>
                  <div className="hint">FC band</div>
                </div>

                <div className="row">
                  <Field label="FC Enable (OAT ≤ …) °C" tip="Operasyonel eşik (kontrol mantığı).">
                    {numInput("fcEnableC")}
                  </Field>
                  <Field label="FC Approach (°C)" tip="Dry cooler + plate HX toplam yaklaşım.">
                    {numInput("fcApproachC")}
                  </Field>
                </div>

                <div className="row">
                  <Field label="Adiabatic" tip="Adiabatic kullanılırsa efektif OAT düşer (basitleştirilmiş).">
                    <select value={s.useAdiabatic ? "YES":"NO"} onChange={(e)=>set("useAdiabatic", e.target.value==="YES")}>
                      <option value="NO">Yok</option>
                      <option value="YES">Var</option>
                    </select>
                  </Field>
                  <Field label="Adiabatic Gain (°C)" tip="Temsili OAT düşüşü. Gerçekte RH/DB/WB bağlıdır.">
                    {numInput("adiabaticGainC", {disabled: !s.useAdiabatic})}
                  </Field>
                </div>
              </div>

              <div className={(compact ? "card12 card" : "card")}>
                <div className="title">
                  <div className="titleLeft">Part‑Load & COP</div>
                  <div className="hint">IPLV‑benzeri</div>
                </div>

                <div className="row">
                  <Field label="Part‑Load aktif" tip="PLR = Load/Design. COPeff = COPbase × multiplier.">
                    <select value={s.enablePartLoad ? "YES":"NO"} onChange={(e)=>set("enablePartLoad", e.target.value==="YES")}>
                      <option value="YES">Evet</option>
                      <option value="NO">Hayır</option>
                    </select>
                    <div className="small">Aktifse düşük yükte verim “multiplier” ile modellenir.</div>
                  </Field>
                  <Field label="Design Cooling (kWth)" tip="Chiller plant nominal kapasite (PLR için).">
                    {numInput("designCoolingkW")}
                  </Field>
                </div>

                <div className="row">
                  <Field label="Min PLR" tip="Minimum stabil çalışma (temsilidir).">
                    {numInput("minPLR", {step:"0.01"})}
                  </Field>
                  <Field label="COP@Ref" tip="Referans lift’te COP.">
                    {numInput("copAtRef", {step:"0.1"})}
                  </Field>
                </div>

                <div className="row">
                  <Field label="Ref Lift (°C)" tip="Referans sıcaklık kaldırma (Tcond-Tevap).">
                    {numInput("refLiftC")}
                  </Field>
                  <Field label="COP slope /°C" tip="Lift artınca COP düşüş eğimi.">
                    {numInput("copSlopePerC", {step:"0.01"})}
                  </Field>
                </div>

                <div className="row">
                  <Field label="COP min" tip="Model alt sınırı.">
                    {numInput("copMin", {step:"0.1"})}
                  </Field>
                  <Field label="COP max" tip="Model üst sınırı.">
                    {numInput("copMax", {step:"0.1"})}
                  </Field>
                </div>
              </div>

              <div className={(compact ? "card12 card" : "card")}>
                <div className="title">
                  <div className="titleLeft">Yardımcılar & Ekonomi</div>
                  <div className="hint">tarife + payback</div>
                </div>

                <div className="row">
                  <Field label="Pompa (% load)" tip="Pompa gücünü soğutma yüküne oranla yaklaşıkla.">
                    {numInput("pumpPowerPct")}
                  </Field>
                  <Field label="Fan (% load)" tip="Dry cooler fan gücü ~ load’a oran. (basit yaklaşım)">
                    {numInput("fanPowerPct")}
                  </Field>
                </div>

                <div className="row">
                  <Field label="FC HX cezası (% load)" tip="Free cooling’de ek HX kaybı + pompa ihtiyacı.">
                    {numInput("hxPenaltyPct")}
                  </Field>
                  <Field label="Tarife ($/kWh)" tip="Enerji birim maliyeti.">
                    {numInput("tariff", {step:"0.01"})}
                  </Field>
                </div>

                <div className="row">
                  <Field label="CAPEX farkı ($)" tip="Senaryoya özel ek yatırım (adiabatic, daha büyük coil vb.).">
                    {numInput("capexDelta")}
                    <div className="small">Payback, A-B CAPEX farkı / yıllık tasarruf ile hesaplanır.</div>
                  </Field>
                  <div className="panel">
                    <div style={{fontWeight:950, marginBottom:6}}>Hızlı Not</div>
                    <div className="small">Gerçek projede: N+1, min akış, VFD eğrileri, kule/dry‑cooler selection, pompaj head, ΔT ve işletme stratejisi eklenmeli.</div>
                  </div>
                </div>
              </div>

              <div className="card12 card">
                <div className="title">
                  <div className="titleLeft">İklim & Simülasyon</div>
                  <div className="hint">preset / csv</div>
                </div>

                <div className="row">
                  <Field label="İklim Modu" tip="Şehir binleri (temsili) veya CSV saatlik sıcaklıklar.">
                    <select value={s.climateMode} onChange={(e)=>set("climateMode", e.target.value)}>
                      <option value="PRESET">Şehir preset (temsili)</option>
                      <option value="CSV">CSV/saatlik yapıştır</option>
                    </select>
                  </Field>
                  <Field label="Aralık (Tmin/Tmax/Step)" tip="Grafikler için OAT sweep aralığı.">
                    <div className="row3" style={{marginBottom:0}}>
                      {numInput("tMin")}
                      {numInput("tMax")}
                      {numInput("tStep")}
                    </div>
                  </Field>
                </div>

                {s.climateMode==="PRESET" ? (
                  <div className="row">
                    <Field label="Şehir" tip="Temsili saat dağılımı. Gerçek proje için CSV önerilir.">
                      <select value={s.cityKey} onChange={(e)=>set("cityKey", e.target.value)}>
                        {CITY_PROFILES.map(c=><option key={c.key} value={c.key}>{c.name}</option>)}
                      </select>
                      <div className="small">Preset temsili; gerçek meteoroloji değildir.</div>
                    </Field>
                    <Field label="CSV saat ölçeği" tip="Preset modda kullanılmaz.">
                      {numInput("csvHoursScale", {disabled:true})}
                    </Field>
                  </div>
                ) : (
                  <div className="row">
                    <Field label="CSV Sıcaklıklar" tip="Sayısal değerleri ayıklar. Tarih/saat içerse de olur.">
                      <textarea
                        className={fieldErr["csvText"] ? "isBad" : ""}
                        value={s.csvText}
                        onChange={(e)=>set("csvText", e.target.value)}
                        placeholder={"12.3\\n11.8\\n... veya: 2025-01-01, 8.2"}
                      />
                      {fieldErr["csvText"] ? <div className="fieldErr">{fieldErr["csvText"]}</div> : null}
                      <div className="small">Timestamp’li veri ile gerçek aylık breakdown yapılabilir.</div>
                    </Field>
                    <Field label="Saat hedefi (8760)" tip="CSV satır sayısı 8760 değilse ölçeklenir.">
                      {numInput("csvHoursScale")}
                      <div className="pill" style={{marginTop:10}}>Algılanan: <span className="mono">{parseCSVTemps(s.csvText).length}</span></div>
                    </Field>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      function MonthlyTable({ rows }) {
        return (
          <div style={{overflowX:"auto"}}>
            <table style={{width:"100%", borderCollapse:"collapse", fontSize:12}}>
              <thead>
                <tr style={{textAlign:"left"}}>
                  <th style={{padding:"8px 6px", borderBottom:"1px solid var(--border)"}}>Ay</th>
                  <th style={{padding:"8px 6px", borderBottom:"1px solid var(--border)"}} className="right">Cooling (MWh)</th>
                  <th style={{padding:"8px 6px", borderBottom:"1px solid var(--border)"}} className="right">Total (MWh)</th>
                  <th style={{padding:"8px 6px", borderBottom:"1px solid var(--border)"}} className="right">FC saat</th>
                  <th style={{padding:"8px 6px", borderBottom:"1px solid var(--border)"}} className="right">Mech saat</th>
                </tr>
              </thead>
              <tbody>
                {rows.map((r,i)=>(
                  <tr key={i}>
                    <td style={{padding:"8px 6px", borderBottom:"1px solid var(--border)"}}><b>{r.m}</b></td>
                    <td style={{padding:"8px 6px", borderBottom:"1px solid var(--border)"}} className="right">{round(r.E_cool/1000,1)}</td>
                    <td style={{padding:"8px 6px", borderBottom:"1px solid var(--border)"}} className="right">{round(r.E_total/1000,1)}</td>
                    <td style={{padding:"8px 6px", borderBottom:"1px solid var(--border)"}} className="right">{round(r.fcH,0)}</td>
                    <td style={{padding:"8px 6px", borderBottom:"1px solid var(--border)"}} className="right">{round(r.mechH,0)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      function App() {
        const [tab, setTab] = useState("compare");
        const marker = "__TERMOLOOP_PRO_DC_SNAPSHOT__";

        const fromLS = (() => {
          try{
            const raw = localStorage.getItem(marker);
            if(!raw) return null;
            return JSON.parse(raw);
          }catch(e){ return null; }
        })();

        const [A, setA] = useState(fromLS?.A ? fromLS.A : ({ ...makeScenarioDefaults(), name:"Senaryo A" }));
        const [B, setB] = useState(fromLS?.B ? fromLS.B : ({ ...makeScenarioDefaults(), name:"Senaryo B", useAdiabatic:true, capexDelta: 25000 }));

        const [ioText, setIoText] = useState("");

        const resA = useMemo(()=>computeAnnual(A), [A]);
        const resB = useMemo(()=>computeAnnual(B), [B]);

        useMemo(()=>{
          try{ localStorage.setItem(marker, JSON.stringify({A,B})); }catch(e){}
        }, [A,B]);

        const savingsTotal = resA.costTotal - resB.costTotal;
        const capexDiff = (B.capexDelta - A.capexDelta);
        const paybackYears = savingsTotal > 0 ? (capexDiff / savingsTotal) : Infinity;

        const topBadge = (
          <div className="badge">
            <b>PUE A:</b> <span className="mono">{round(resA.pue,3)}</span> • <b>PUE B:</b> <span className="mono">{round(resB.pue,3)}</span>
            &nbsp;• <b>FC% A:</b> <span className="mono">{round(resA.fcSharePct,1)}%</span> • <b>FC% B:</b> <span className="mono">{round(resB.fcSharePct,1)}%</span>
          </div>
        );

        const exportAll = () => downloadJSON("termoloop-pro-dc-scenarios.json", { A, B });
        const copyExportText = () => setIoText(JSON.stringify({ A, B }, null, 2));

        const importAll = () => {
          try {
            const obj = JSON.parse(ioText);
            if (obj.A) setA(obj.A);
            if (obj.B) setB(obj.B);
            alert("Import OK");
          } catch (e) {
            alert("JSON parse hatası: " + e.message);
          }
        };

        const resetDefaults = () => {
          if (!confirm("A ve B senaryoları varsayılanlara dönsün mü?")) return;
          setA({ ...makeScenarioDefaults(), name:"Senaryo A" });
          setB({ ...makeScenarioDefaults(), name:"Senaryo B", useAdiabatic:true, capexDelta: 25000 });
        };

        const downloadThisHTML = () => downloadHTMLSnapshot("termoloop-pro-dc.html", {A,B});

        return (
          <div className="wrap">
            <div className="topbar">
              <div>
                <div className="brandRow">
                  <div className="logo" aria-hidden="true"></div>
                  <div>
                    <h1>TermoLoop Pro DC — PUE • Free Cooling • Part‑Load • Scenario Compare</h1>
                    <div className="sub">
                      Tek dosya <span className="mono">index.html</span> (Cloudflare Pages uyumlu).
                      Ayarlar otomatik kaydedilir; istersen “HTML indir” ile snapshot alabilirsin.
                    </div>
                  </div>
                </div>
              </div>
              {topBadge}
            </div>

            <div className="tabs">
              <button className={"tabBtn "+(tab==="compare"?"active":"")} onClick={()=>setTab("compare")}>Karşılaştır</button>
              <button className={"tabBtn "+(tab==="scenarioA"?"active":"")} onClick={()=>setTab("scenarioA")}>Senaryo A</button>
              <button className={"tabBtn "+(tab==="scenarioB"?"active":"")} onClick={()=>setTab("scenarioB")}>Senaryo B</button>
              <button className={"tabBtn "+(tab==="io"?"active":"")} onClick={()=>setTab("io")}>Export / Import</button>
              <button className={"tabBtn "+(tab==="report"?"active":"")} onClick={()=>setTab("report")}>Rapor</button>
            </div>

            {tab==="compare" && (
              <div className="grid">
                <div className="card12 card">
                  <div className="title">
                    <div className="titleLeft">
                      KPI Karşılaştırma
                      <span className="pill">A: {resA.profileName}</span>
                      <span className="pill">B: {resB.profileName}</span>
                    </div>
                    <div className="btnRow">
                      <button className="btn" onClick={downloadThisHTML} title="Mevcut ayarlarla tek dosya HTML indir">HTML indir</button>
                      <button className="btn" onClick={exportAll} title="A+B JSON indir">JSON indir</button>
                      <button className="btn danger" onClick={resetDefaults} title="Varsayılanlara dön">Reset</button>
                    </div>
                  </div>

                  <div className="kpiGrid">
                    <div className="kpi">
                      <div className="kpiLbl">PUE (ortalama)</div>
                      <div className="kpiVal">{round(resA.pue,3)} → {round(resB.pue,3)}</div>
                      <div className="small">Düşüş: <span className="mono">{round(resA.pue-resB.pue,3)}</span></div>
                    </div>

                    <div className="kpi">
                      <div className="kpiLbl">Yıllık Toplam Enerji</div>
                      <div className="kpiVal">{round(resA.E_total/1000,1)} → {round(resB.E_total/1000,1)} MWh</div>
                      <div className="small">Δ: <span className="mono">{round((resA.E_total-resB.E_total)/1000,1)} MWh</span></div>
                    </div>

                    <div className="kpi">
                      <div className="kpiLbl">Soğutma Enerjisi</div>
                      <div className="kpiVal">{round(resA.E_cool/1000,1)} → {round(resB.E_cool/1000,1)} MWh</div>
                      <div className="small">Δ: <span className="mono">{round((resA.E_cool-resB.E_cool)/1000,1)} MWh</span></div>
                    </div>

                    <div className="kpi">
                      <div className="kpiLbl">FC Payı</div>
                      <div className="kpiVal">{round(resA.fcSharePct,1)}% → {round(resB.fcSharePct,1)}%</div>
                      <div className="small">FC saat: <span className="mono">{round(resA.fcHours,0)}</span> → <span className="mono">{round(resB.fcHours,0)}</span></div>
                    </div>
                  </div>

                  <div style={{marginTop:12}} className="kpiGrid2">
                    <div className="kpi">
                      <div className="kpiLbl">Yıllık Enerji Maliyeti</div>
                      <div className="kpiVal">${round(resA.costTotal,0)} → ${round(resB.costTotal,0)}</div>
                      <div className="small">Tasarruf (B): <span className="mono">${round(savingsTotal,0)}/yıl</span></div>
                    </div>

                    <div className="kpi">
                      <div className="kpiLbl">Basit Geri Ödeme</div>
                      <div className="kpiVal">{Number.isFinite(paybackYears) ? round(paybackYears,2) + " yıl" : "—"}</div>
                      <div className="small">
                        CAPEX farkı (B-A): <span className="mono">${round(capexDiff,0)}</span> • Tarife: <span className="mono">${A.tariff}/kWh</span> / <span className="mono">${B.tariff}/kWh</span>
                      </div>
                    </div>
                  </div>

                  <div className="divider"></div>

                  <div className="grid">
                    <div className="card">
                      <div className="title">
                        <div className="titleLeft">{A.name} • Interaktif</div>
                        <span className="pill">Mod saat kırılımı</span>
                      </div>
                      <div className="small" style={{marginBottom:8}}>Hover: OAT, mod, PLR, COPeff. Açık band = FC bölgesi.</div>
                      <InteractiveChart data={resA.curveKW} title="Cooling kW vs OAT (A)" />
                      <div style={{marginTop:10}}>
                        <StackedModeBar fcH={resA.fcHours} mechH={resA.mechHours} />
                      </div>
                    </div>

                    <div className="card">
                      <div className="title">
                        <div className="titleLeft">{B.name} • Interaktif</div>
                        <span className="pill">Mod saat kırılımı</span>
                      </div>
                      <div className="small" style={{marginBottom:8}}>Hover: OAT, mod, PLR, COPeff. Açık band = FC bölgesi.</div>
                      <InteractiveChart data={resB.curveKW} title="Cooling kW vs OAT (B)" />
                      <div style={{marginTop:10}}>
                        <StackedModeBar fcH={resB.fcHours} mechH={resB.mechHours} />
                      </div>
                    </div>

                    <div className="card12 card">
                      <div className="title">
                        <div className="titleLeft">Part‑Load Etkisi (COPeff)</div>
                        <span className="pill">IPLV‑benzeri</span>
                      </div>
                      <div className="small" style={{marginBottom:8}}>
                        COPeff, COPbase × PLR_multiplier. FC bölgelerinde COP “çok büyük” gösterilir; bu grafikte 12 ile sınırlandı.
                      </div>
                      <div className="grid">
                        <div className="card">
                          <div className="title"><div className="titleLeft">{A.name} • COPeff</div></div>
                          <InteractiveChart data={resA.curveCOP.map(d=>({ ...d, y: Math.min(d.y, 12) }))} title="COPeff vs OAT (A) (cap=12)" />
                        </div>
                        <div className="card">
                          <div className="title"><div className="titleLeft">{B.name} • COPeff</div></div>
                          <InteractiveChart data={resB.curveCOP.map(d=>({ ...d, y: Math.min(d.y, 12) }))} title="COPeff vs OAT (B) (cap=12)" />
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            )}

            {tab==="scenarioA" && (
              <div className="card12 card">
                <div className="title">
                  <div className="titleLeft">
                    {A.name} Ayarları
                    <span className="pill">Profil: {resA.profileName}</span>
                    <span className="pill">PUE: {round(resA.pue,3)}</span>
                    <span className="pill">FC%: {round(resA.fcSharePct,1)}%</span>
                  </div>
                  <button className="btn" onClick={()=>setTab("compare")}>← Karşılaştır</button>
                </div>
                <ScenarioEditor s={A} setS={setA} compact />
              </div>
            )}

            {tab==="scenarioB" && (
              <div className="card12 card">
                <div className="title">
                  <div className="titleLeft">
                    {B.name} Ayarları
                    <span className="pill">Profil: {resB.profileName}</span>
                    <span className="pill">PUE: {round(resB.pue,3)}</span>
                    <span className="pill">FC%: {round(resB.fcSharePct,1)}%</span>
                  </div>
                  <button className="btn" onClick={()=>setTab("compare")}>← Karşılaştır</button>
                </div>
                <ScenarioEditor s={B} setS={setB} compact />
              </div>
            )}

            {tab==="io" && (
              <div className="grid">
                <div className="card4 card">
                  <div className="title"><div className="titleLeft">Export / Import</div></div>

                  <button className="btn primary" onClick={exportAll} style={{width:"100%", marginBottom:8}}>JSON Download (A+B)</button>
                  <button className="btn" onClick={copyExportText} style={{width:"100%", marginBottom:8}}>JSON’u Kutucuğa Yaz</button>
                  <button className="btn" onClick={importAll} style={{width:"100%", marginBottom:8}}>Kutucuktan Import</button>

                  <button className="btn" onClick={downloadThisHTML} style={{width:"100%", marginBottom:8}}>Mevcut Ayarlarla HTML indir</button>

                  <div className="small">
                    Not: iOS/Safari’de dosya indirme davranışı tarayıcıya göre değişebilir. Metin import her zaman çalışır.
                  </div>
                </div>

                <div className="card8 card">
                  <div className="title"><div className="titleLeft">JSON</div></div>
                  <textarea value={ioText} onChange={(e)=>setIoText(e.target.value)} placeholder='{"A": {...}, "B": {...}}'></textarea>
                </div>
              </div>
            )}

            {tab==="report" && (
              <div className="grid">
                <div className="card12 card">
                  <div className="title">
                    <div className="titleLeft">Detaylı Raporlama</div>
                    <span className="pill">Aylık (temsili) + Mod saat</span>
                  </div>

                  <div className="kpiGrid">
                    <div className="kpi">
                      <div className="kpiLbl">A: Cooling (MWh) / Total (MWh)</div>
                      <div className="kpiVal">{round(resA.E_cool/1000,1)} / {round(resA.E_total/1000,1)}</div>
                      <div className="small">FC: <span className="mono">{round(resA.fcHours,0)}</span> h • MECH: <span className="mono">{round(resA.mechHours,0)}</span> h</div>
                    </div>
                    <div className="kpi">
                      <div className="kpiLbl">B: Cooling (MWh) / Total (MWh)</div>
                      <div className="kpiVal">{round(resB.E_cool/1000,1)} / {round(resB.E_total/1000,1)}</div>
                      <div className="small">FC: <span className="mono">{round(resB.fcHours,0)}</span> h • MECH: <span className="mono">{round(resB.mechHours,0)}</span> h</div>
                    </div>
                    <div className="kpi">
                      <div className="kpiLbl">A: Yıllık Maliyet</div>
                      <div className="kpiVal">${round(resA.costTotal,0)}</div>
                      <div className="small">Tarife: <span className="mono">${A.tariff}/kWh</span></div>
                    </div>
                    <div className="kpi">
                      <div className="kpiLbl">B: Yıllık Maliyet</div>
                      <div className="kpiVal">${round(resB.costTotal,0)}</div>
                      <div className="small">Tarife: <span className="mono">${B.tariff}/kWh</span></div>
                    </div>
                  </div>
                </div>

                <div className="card card">
                  <div className="title"><div className="titleLeft">Aylık Dağılım — {A.name}</div></div>
                  <div className="small" style={{marginBottom:8}}>
                    Aylık dağılım temsili ağırlıklarla bölünür. Timestamp’li veri olursa gerçek aylık breakdown eklenir.
                  </div>
                  <MonthlyTable rows={resA.monthly} />
                </div>

                <div className="card card">
                  <div className="title"><div className="titleLeft">Aylık Dağılım — {B.name}</div></div>
                  <div className="small" style={{marginBottom:8}}>Aynı yöntem.</div>
                  <MonthlyTable rows={resB.monthly} />
                </div>

                <div className="card12 card">
                  <div className="title"><div className="titleLeft">Model Notları</div></div>
                  <ul className="small" style={{margin:0, paddingLeft:18}}>
                    <li><b>Part‑load:</b> PLR = CoolingLoad / DesignCooling. COPeff = COPbase × PLR_multiplier.</li>
                    <li><b>FC modu:</b> Kompresör 0 kabul edilir; pompa + fan + HX cezası kalır.</li>
                    <li><b>Ekonomi:</b> Basit geri ödeme = (CAPEX farkı) / (yıllık enerji maliyeti tasarrufu).</li>
                    <li><b>Kalibrasyon:</b> Üretici performans noktalarıyla COP & part‑load eğrilerini (IPLV/NPLV) kalibre et.</li>
                  </ul>
                </div>
              </div>
            )}

            <div className="small" style={{marginTop:14, opacity:.78}}>
              <b>TermoLoop Professional Data Center</b> • © konsept analiz • “Close the Loop”
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
